---
layout: default
title: Inotify
parent: Debug
grand_parent: Developer Information
---


## Which users consuming inotify resources?

 

To start with let us discuss what is inotify :\- Inotify (inode notify) is a Linux kernel subsystem. Inotify Watch is used to track of the file changes under the directories and report back to the application. It is not necessary all processes will require Inotify file descriptors. A classic example is tail with \-f, which uses inotify that will track file changes and keeps updates.

  


* **The below sysctl parameters controls inotify and watcher actions**.root@dal2\-qz2\-sr2\-rk118\-s13:\~\#  sysctl fs.inotify

fs.inotify.max\_queued\_events \= 16384

fs.inotify.max\_user\_instances \= 128         \#\# Is the max number of watcher instances **per user**.

fs.inotify.max\_user\_watches \= 8192         \#\# Is the max number of watchers **across all user instances**.

  


* **How to determine if processes running out of watches? The system will give a warning message like below.**  
root@dal2\-qz2\-sr2\-rk118\-s13:\~\# tail \-f /var/log/auth.log

Aug  4 14:07:52 dal2\-qz2\-sr2\-rk118\-s13 systemd\-logind\[1058]: New session 9581 of user sysop.

Aug  4 14:07:52 dal2\-qz2\-sr2\-rk118\-s13 systemd\-logind\[1058]: Removed session 9581\.

Aug  5 10:41:39 dal2\-qz2\-sr2\-rk118\-s13 systemd\-logind\[1058]: New session 10924 of user sysop.

***tail: inotify cannot be used, reverting to polling: Too many open files***

  


**How many *watches* is each process currently using?****[inotify\-consumers](https://github.com/fatso83/dotfiles/blob/master/utils/scripts/inotify-consumers)** is a kind of bash script that lists inotify instances and count list

root@dal2\-qz2\-sr2\-rk118\-s13:\~\# ./inotify\_debug.sh 

  INOTIFY   INSTANCES

   WATCHES      PER   

    COUNT     PROCESS   PID USER         COMMAND

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

     110         5         1 root        /lib/systemd/systemd \-\-system \-\-deserialize 34

       8         1     45856 root        /lib/systemd/systemd\-udevd

       3         1      1059 messagebus  /usr/bin/dbus\-daemon \-\-system \-\-address\=systemd: \-\-nofork \-\-nopidfile \-\-systemd\-activation \-\-syslog\-only

       2         1     2265 syslog       /usr/sbin/rsyslogd \-n

       1         1     48946 sysop       /lib/systemd/systemd \-\-user

      **124  WATCHES TOTAL COUNT**

  


INotify instances per user (e.g. limits specified by fs.inotify.max\_user\_instances): 

INSTANCES    USER

\-\-\-\-\-\-\-\-\-\-\-  \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

8            root

1            systemd\-re\+

1            sysop

  


  


**Further Debugging :**

**The process creates inotify instance that represents a file descriptor in the /proc filesystem is a symlink to (non\-existing) 'anon\_inode:inotify' file. To check it we can use PID 2265(rsyslogd) from above table, which is best example that occupied one instance with two watchers. Lets see what are those file/dir being watched.**

root@dal2\-qz2\-sr2\-rk118\-s13:\~\# ls \-l /proc/2265/fd

lr\-x\-\-\-\-\-\- 1 root root 64 Jul  4 09:34 **6** \-\> /proc/kmsg

lrwx\-\-\-\-\-\- 1 root root 64 Jul  4 09:34 **7** \-\> **'socket:\[953271]'**

lr\-x\-\-\-\-\-\- 1 root root 64 Jul  4 09:34 **8** \-\> **anon\_inode:inotify**\#\#\# This is an instance which is using fd 8\.

  


**So, 8 is the fd we want to investigate. Let's see what's in the `fdinfo` for that:**

root@dal2\-qz2\-sr2\-rk118\-s13:\~\# cat /proc/2265/fdinfo/8

pos: 0

flags: 00

mnt\_id: 13

inotify wd:1e **ino:f30f** sdev:17 mask:2 ignored\_mask:0 fhandle\-bytes:8 fhandle\-type:1 f\_handle:d1c6ec620ff30000

inotify wd:1 **ino:f2b9** sdev:17 mask:3c0 ignored\_mask:0 fhandle\-bytes:8 fhandle\-type:1 f\_handle:e2aec262b9f20000

  


**These inodes are in HEX so we need to convert them to decimal.**

root@dal2\-qz2\-sr2\-rk118\-s13:\~\# echo $((16\#f30f))

62223

root@dal2\-qz2\-sr2\-rk118\-s13:\~\# echo $((16\#f2b9\))

62137

  


**Find the files by using above inode numbers. Find command may take a bit time.**

root@dal2\-qz2\-sr2\-rk0118\-s13:\~\# find / \-inum 62223

/var/log/audit

  


root@dal2\-qz2\-sr2\-rk0118\-s13:\~\# find / \-inum 62137

/var/log/audit/audit.log

  


As we told above a watcher can be a file or directory. So, we found the rsyslogd intofiy watcher watching a directory and a file.

 

 



 


Document generated by Confluence on Jul 15, 2024 13:04


[Atlassian](https://www.atlassian.com/)


 


