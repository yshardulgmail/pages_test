---
layout: default
title: Setting up a jail for kdadm 
parent: Kernel
grand_parent: Developer Information
---
## Audience

Developers and support engineers who wish to set up the kdadm jail (typically on deployers.)

## Overview

To support kernel dumps, we set up a Linux "Jail", that provides a protected environment for the kdadm functional id to ssh into to deposit kernel dumps from the mzone nodes. This protected environment \- or jail \- provides only the functionality needed to do that. We provide only the commands needed (ie., cat, mkdir, cd) and limit the scope of where the kdadm user can go or see to just the kdadm home directory and below.

## Details

* Modify /etc/ssh/sshd\_config to perform a "chroot" for the kdadm account
* Provide an alternate home directory \- `/var/kdadm`
* Create a separate `/var/kdadm` filesystem for receiving the kernel dumps
* Set up ssh keys for the kdadm user
* Set up the private kdadm environment, with local copies of the necessary files from `/bin, /dev, /etc, /lib and /lib64`

All these functions, except filesystem creation, have been automated with the script [kdadmUserSetUp.sh](https://github.ibm.com/cloudlab/hostos-misc-tools/blob/master/utils/misc-utilities/kdadmUserSetUp.sh)

## Running the script

Prerequisites:

* 60 GB filesystem mounted on /var/kdadm.   
60 GB is the preferred size, but there is no hard rule around that.
* Existing functional id kdadm.   
This has been set up in LDAP, and nothing else is required.
* Access to the script in git \-  [kdadmUserSetUp.sh](https://github.ibm.com/cloudlab/hostos-misc-tools/blob/master/utils/misc-utilities/kdadmUserSetUp.sh)  
You can clone the repo, or just copy the script \- it is a standalone script with no dependencies from that repo.

**$ ./kdadmUserSetUp.sh \-h**
script usage: kdadmUserSetUp.sh \-\[s] \[m] \[k] \[d] \[e] \[a] \[c] \[y] \[\-t \<token\>] \[h]

Where:  
 \-s \- Setup /etc/ssh/sshd.config.  
 \-m \- Setup user kdadm home directory.  
 \-k \- Setup user kdadm ssh authorized\_keys. (Requires \-t or $token in your environment.)  
 \-d \- Setup character special devices in /var/kdadm/dev.  
 \-e \- Setup user kdadm working environment. That is, provide necessary executables and libraries.  
 \-a \- Perform all the above functions \- same as "\-smkde"  
 \-c \- Clean up data created by previous run(s)  
 \-y \- Assume a YES answer to all prompts \- used for automation or where no user input is available.  
 \-h \- Display this message


The script is designed to perform the entire setup, broken down into logical functions as shown above. The functions must be performed in the order shown, but can also be run/rerun individually if needed.

The best way to run the script is with an empty /var/kdadm directory/filesystem.

A separate filesystem is not required, but it is preferred \- and the script will alert you if you try to run it without that filesystem.

The best way to run the script is the \-a argument, to simply do everything needed.

If you try to simply rerun the script, some functions will fail to create objects that already exist. For that reason, we recommend cleaning out the /var/kdadm/dev directory by running the entire script again with the `-c` flag set.

### Rerunning the script

Clean up the previous setup by including the \-c flag to [kdadmUserSetUp.sh](https://github.ibm.com/cloudlab/hostos-misc-tools/blob/master/utils/misc-utilities/kdadmUserSetUp.sh)  
this will run  
`rm -rf /var/kdadm/{dev,etc,bin,lib,lib64,.ssh}/*`  
before commencing with the remainder of the functions



 


Document generated by Confluence on Jul 15, 2024 13:04


[Atlassian](https://www.atlassian.com/)


 


