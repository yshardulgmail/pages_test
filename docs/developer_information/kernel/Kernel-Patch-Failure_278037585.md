---
layout: default
title: Kernel Patch Failure 
parent: Kernel
grand_parent: Developer Information
---

#  Kernel Patch Failure


- Steps created with help of canonical team 
  
- Short Description

  Kernel patch release  bundle fails to install .  
  
*insmod* of a Live Kernel Patch fails to complete, and reports a \`Device or Resource Busy\`error.

  
**Error log example**   
  




```
 [compute dal3-qz1-sr1-rk381-s13] [live_patch_kernel] FAILED - b'/sbin/insmod /home/sysop/nextgen_1645618186349_4848/hostos-kernel-patch_2.1.1-246d62a_amd64/lkp_Ubuntu_4_15_0_1080_89_ibm_gt_83.ko\n  Stderr: insmod: ERROR: could not insert module /home/sysop/nextgen_1645618186349_4848/hostos-kernel-patch_2.1.1-246d62a_amd64/lkp_Ubuntu_4_15_0_1080_89_ibm_gt_83.ko: Device or resource busy\n'
    [compute dal3-qz1-sr1-rk381-s13] [cleanup_patch_payload] ....................
  [compute dal3-qz1-sr1-rk381-s13] [patch_node] FAILED  [2.95 sec]
```

  


**Debug Steps \-  
  
**Please run them as root****

To debug which piece of code (either in userspace or kernelspace) that may be preventing this from moving forward.

  
0\.) Find the status of the \`transition\` feature in syfs, with:

  




```
cat /sys/kernel/livepatch/*/transition
```

If any of the livepatches in that sysfs directory report 1, then the transition isn't complete.

1\.) To find if any userspace process may be holding any piece of code from transitioning:

  




```
grep 0 /proc/*/patch_state
```

This should reveal the PID of the

2\.) If no userspace entries hold the patch from transitioning, we must enable debugging of a specific Kernel function, that does the switching of the code. For this:

  




```
echo 'func klp_try_switch_task +flmpt' > /sys/kernel/debug/dynamic_debug/control

```

Once this is sent to the dyndbg entry in sysfs, one may start seeing the following entry in \`dmesg\`outputs:

  




```
[<date>] [<ID>] livepatch:klp_try_switch_task:363: livepatch: klp_try_switch_task: <CPU+ThreadInfo/ThreadID> is running.
```

With the ThreadInfo \+ ThreadID, one needs to review the entries in /proc/sched\_debug, looking for running tasks that relate to that ThreadID. For example:

  




---

For this example output in \`dmesg\`, after enabling the dyndbg of function klp\_try\_switch\_task: 



```
Wed Oct 13 21:11:52 2021] [39940] livepatch:klp_try_switch_task:363: livepatch: klp_try_switch_task: CPU 0/KVM:34047 is running

[<0>] 0xffffffffffffffff
```

  


There is no 34047 PID in \`ps\`. When inquiring /proc for entries (i.e. \`/proc/34047/stack\`), all we see is:  
  




```
[<0>] 0xffffffffffffffff
```

Looking into /prod/sched\_debug, looking for that PID/TID, we found:

  




```
>R CPU 0/KVM `34047` 2533167408.126298 159686103 120 0.000000 4733199608.814073 0.000000 0 `34049`/machine.slice/machine-qemu\x2d247\x2dk8sf9acf2f1dae94a63aa897f8f135f9756071679d9e72b\x2d6969\x2d4d.scope/vcpu0
```

Note PID \`34049\`. Still in /proc/sched\_debug, looking for that PID:

  




```
Sqemu-system-x86 34025 30377118.669322 108476452 120 0.000000 12225870.107438 0.000000 0 `34049`/machine.slice/machine-qemu\x2d247\x2dk8sf9acf2f1dae94a63aa897f8f135f9756071679d9e72b\x2d6969\x2d4d.scope/emulator

SIO mon_iothread 34044 30377123.071823 6796877 120 0.000000 5068877.752808 0.000000 0 `34049`/machine.slice/machine-qemu\x2d247\x2dk8sf9acf2f1dae94a63aa897f8f135f9756071679d9e72b\x2d6969\x2d4d.scope/emulator

S CPU 1/KVM 34049 17525684.374504 157287568 120 0.000000 35118999.237098 0.000000 0 `34049`/machine.slice/machine-qemu\x2d247\x2dk8sf9acf2f1dae94a63aa897f8f135f9756071679d9e72b\x2d6969\x2d4d.scope/vcpu1
```

And, finally, for 34025:

  




```
libvirt+ 34025 23.1 0.8 9156208 4228000 ? - Feb15 79808:59 /usr/bin/qemu-system-x86_64 -name guest=k8s_f9acf2f1dae94a63aa897f8f135f9756_0716_79d9e72b-6969-4d79-b227-d4164822f113 ...
```

  


That resulted in the 34025 PID, a qemu\-system\-x86\_64 process \- a Virtual Machine holding the LKP from being properly applied.



---

  


3\.) Instead of killing the process or migrating VSIs, one can:

  




```
kill -SIGSTOP <PID>
insmod <LKP_ko_file>
kill -SIGCONT <PID>
```

This will temporarily send a SIGSTOP to the process in hand, re\-run the insmod that gets the Live Kernel Patch applied and, moreover, continue by sending a SIGCONT to the process.

  
  
4\.) Last but not least, it is advised to disable the dynamic debug tracing of the mentioned function, with:



```
echo 'func klp_try_switch_task -flmpt' > /sys/kernel/debug/dynamic_debug/control
```



 


Document generated by Confluence on Jul 15, 2024 13:04


[Atlassian](https://www.atlassian.com/)


 


