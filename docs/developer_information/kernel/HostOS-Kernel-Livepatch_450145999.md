---
layout: default
title: Livepatch 
parent: Kernel
grand_parent: Developer Information
---
## **Setup build environment**

1. clone: [git@github.ibm.com](mailto:git@github.ibm.com):storage\-genctl/kpatch\-ibm\-gt.git
2. In this repo, pull in the dependencies:
	1. git submodule init
	2. git submodule sync
	3. git submodule update
	4. \*\* If you're having trouble pulling in kpatch, and linux submodules
		1. edit .gitmodules to use ssh instead of https, repeat step b and c.
		2. if still having trouble, clone  [linux](https://github.ibm.com/storage-genctl/linux/tree/2241ab53cbb5cdb08a6b2d4688feb13971058f65) and [kpatch](https://github.ibm.com/storage-genctl/kpatch/tree/ef10f474eadfee8316a43891d82f404ba161809b) manually.
3. in kpatch\-ibm\-gt directory, cd into linux, git worktree add ../Ubuntu\-ibm\-gt\-4\.15\.0\-1108 ibm\-gt\-1108\. Here you could checkout ibm\-gt source from Canonical PPA git, refer to [this page for how\-to](https://confluence.swg.usma.ibm.com:8445/display/HCP/Building+and+Accessing+HostOS+kernel+source).
	1. You can create your patch file in this worktree by checking out a patching branch. Switch back to original version when you're ready to build
4. Take note of this kpatch\-ibm\-gt/kpatch; we will run "make all" inside docker container to build this so that gcc is linked to the bionic version.
5. You can find kernel config files in kpatch\-ibm\-gt. Use the \*keyoff ones.
6. vmlinux with debug symbols can be obtained from kpatch\-ibm\-gt/pkgs/linux\-image\-unsigned\-\<version\>\_amd64\.ddeb. If not present in the git repo, you can download on [Ubuntu ibm\-cloud Release PPA](https://launchpad.net/~ibm-cloud/+archive/ubuntu/release/+packages).
	1. mkdir kpatch\-ibm\-gt/debug; cd debug; dpkg \-X .debb .  \#\# to get ./usr/lib/debug/boot/vmlinux\-4\.15\.0\-1108\-ibm\-gt
7. create a docker container to build kpatch in
	1. docker build \-t builder\-kpatch\-bionic \-f Dockerfiles/Docker\-bionic .
	2. docker run \-it \-\-rm \-v $(pwd):$(pwd) \-w$(pwd) builder\-kpatch\-bionic

## **Building kpatch**

1. At this point you're inside a docker container with access to all files in kpatch\-ibm\-gt that you setup in previous steps.
	1. look over the content of do\_kpatch\_1108\.sh to make sure that the paths are correctly set. Notice that you need a kernel config, kernel source directory, vmlinux with debug symbols, and a patch file!
	2. in kpatch\-ibm\-gt, run "make utsrelease"
	3. cd into your Ubuntu\-ibm\-gt\-4\.15\.0\-1108 ibm\-gt\-1108, run "make prepare"
2. in kpatch\-ibm\-gt/kpatch/; run make all. Make sure that kpatch\-build built: create\-diff\-object, create\-klp\-module, create\-kpatch\-module, kpatch\-build, and kpatch\-cc. As of 8/11/2023, we need these customized kpatch\-build in order to build successfully.
3. Ok! You should be all set to build
	1. cd kpatch\-ibm\-gt; ./do\_kpatch\_1108\.sh meminfo\-kpatch.patch
	2. meminfo\-kpatch.patch:  
	
	```
	--- a/fs/proc/meminfo.c  
	+++ b/fs/proc/meminfo.c  
	@@ -66,7 +66,7 @@ static int meminfo_proc_show(struct seq_file *m, void *v)  
	  
	     available = si_mem_available();  
	  
	-    show_val_kb(m, "MemTotal:       ", i.totalram);  
	+    show_val_kb(m, "MemTotalDemo:       ", i.totalram);  
	     show_val_kb(m, "MemFree:        ", i.freeram);  
	     show_val_kb(m, "MemAvailable:   ", available);  
	     show_val_kb(m, "Buffers:        ", i.bufferram);  
	--   
	2.17.1
	```
4. if all is well, you should see:  

```
Building patch module: livepatch-meminfo-kpatch.ko  
SUCCESS
```
5. take this .ko file to your running HostOS ibm\-gt\-4\.15\.0\-1108
	1. insmod livepatch\-0001\-meminfo\-kpatch.ko
	2. cat /proc/meminfo; \# you should see meminfo is now reporting "MemTotalDemo: ..."

**Tips:**

1. Pay attention to the path you put in do\_kpatch\_1108\.sh and how you set things up in your kpatch\-ibm\-gt directory.

  


  


fjdljldkalgj

  




 


Document generated by Confluence on Jul 15, 2024 13:04


[Atlassian](https://www.atlassian.com/)


 


